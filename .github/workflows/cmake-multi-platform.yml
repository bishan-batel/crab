name: Tests

on:
  push:
    branches: [ "main" ]
    paths:
      - 'include/**/*.cpp'
      - 'include/**/*.hpp'
      - '**/CMakeLists.txt'
      - '**/*.cmake'
      - 'VERSION'
      - 'CMakeLists.txt'
      - 'CMakePresets.json'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'include/**/*.cpp'
      - 'include/**/*.hpp'
      - '**/CMakeLists.txt'
      - '**/*.cmake'
      - 'VERSION'
      - 'CMakeLists.txt'
      - 'CMakePresets.json'

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false

      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        c_compiler: [clang++, g++, cl]
        build_type: [Debug, Release]
        exclude:
          - os: windows-latest
            c_compiler: g++
          - os: windows-latest
            c_compiler: cl
          - os: ubuntu-latest
            c_compiler: cl
          - os: macos-latest
            c_compiler: cl

    steps:
    - uses: actions/checkout@v4

    - uses: ashutoshvarma/setup-ninja@v1.1
    
    - name: Set up Clang
      uses: egor-tensin/setup-clang@v1
      if: matrix.os != 'macos-latest' && matrix.c_compiler == 'clang++'
      with:
        version: 20
    
    - name: Set up MSVC 
      if: matrix.os == 'windows-latest' && matrix.c_compiler == 'cl'
      uses: ilammy/msvc-dev-cmd@v1

    - name: Configure CMake
      run: cmake -Bbuild -GNinja -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} -DCRAB_TESTS=ON -DCMAKE_CXX_COMPILER=${{matrix.c_compiler}}

    - name: Build
      run: cmake --build build

    - name: Run Tests
      working-directory: build/tests
      run: ./crab-tests -s
